/*
*  Asm Implementation: Interrupt.S
*
* Description: Entry point to Interrupt Handlers
*
*
* Author: Puneet Kaushik <puneet.kaushik@gmail.com>, (C) 2010
*
* Copyright: See COPYRIGHT file that comes with this distribution
*
*/

#include <inc/asm.h>
#include <kern/hal/x86.h>

.intel_syntax noprefix


/* For certain traps the CPU automatically pushes an error code.  For 
 * all other traps, IDTFUNC_NOEC() pushes a 0 in place of the error code,
 * so the trap frame has the same format.
 */


#define TRAPHANDLER(name,num)	 		\
.text;						\
ENTRY(name); 					\
push	num; 					\
jmp	_KiSaveTrapFrame;			\
.data;						\
.long 	name					





#define TRAPHANDLER_NOEC(name,num) 		\
.text;						\
ENTRY(name); 					\
push	0;					\
push	num; 					\
jmp	_KiSaveTrapFrame;			\
.data;						\
.long 	name					




/**********************************************
	TRAP HANDLERS
**********************************************/

//Array of Functionpointers
.data
.globl _TrapFunctionList
_TrapFunctionList:


TRAPHANDLER_NOEC( _KiTrap00,0x0)
TRAPHANDLER_NOEC( _KiTrap01,0x1)
TRAPHANDLER_NOEC( _KiTrap02,0x2)
TRAPHANDLER_NOEC( _KiTrap03,0x3)
TRAPHANDLER_NOEC( _KiTrap04,0x4)
TRAPHANDLER_NOEC( _KiTrap05,0x5)
TRAPHANDLER_NOEC( _KiTrap06,0x6)
TRAPHANDLER_NOEC( _KiTrap07,0x7)
TRAPHANDLER( _KiTrap08,0x8)
TRAPHANDLER_NOEC( _KiTrap09,0x9)
TRAPHANDLER( _KiTrap0A,0xA)
TRAPHANDLER( _KiTrap0B,0xB)
TRAPHANDLER_NOEC( _KiTrap0C,0xC)
TRAPHANDLER( _KiTrap0D,0xD)
TRAPHANDLER( _KiTrap0E,0xE)
TRAPHANDLER_NOEC( _KiTrap0F,0xF)
TRAPHANDLER_NOEC( _KiTrap10,0x10)
TRAPHANDLER_NOEC( _KiTrap11,0x11)
TRAPHANDLER_NOEC( _KiTrap12,0x12)
TRAPHANDLER_NOEC( _KiTrap13,0x13)
TRAPHANDLER_NOEC( _KiTrap14,0x14)
TRAPHANDLER_NOEC( _KiTrap15,0x15)
TRAPHANDLER_NOEC( _KiTrap16,0x16)
TRAPHANDLER_NOEC( _KiTrap17,0x17)
TRAPHANDLER( _KiTrap18,0x18)
TRAPHANDLER_NOEC( _KiTrap19,0x19)
TRAPHANDLER( _KiTrap1A,0x1A)
TRAPHANDLER( _KiTrap1B,0x1B)
TRAPHANDLER_NOEC( _KiTrap1C,0x1C)
TRAPHANDLER( _KiTrap1D,0x1D)
TRAPHANDLER( _KiTrap1E,0x1E)
TRAPHANDLER_NOEC( _KiTrap1F,0x1F)
TRAPHANDLER_NOEC( _KiTrap20,0x20)
TRAPHANDLER_NOEC( _KiTrap21,0x21)
TRAPHANDLER_NOEC( _KiTrap22,0x22)
TRAPHANDLER_NOEC( _KiTrap23,0x23)
TRAPHANDLER_NOEC( _KiTrap24,0x24)
TRAPHANDLER_NOEC( _KiTrap25,0x25)
TRAPHANDLER_NOEC( _KiTrap26,0x26)
TRAPHANDLER_NOEC( _KiTrap27,0x27)
TRAPHANDLER_NOEC( _KiTrap28,0x28)
TRAPHANDLER_NOEC( _KiTrap29,0x29)
TRAPHANDLER_NOEC( _KiTrap2A,0x2A)
TRAPHANDLER_NOEC( _KiTrap2B,0x2B)
TRAPHANDLER_NOEC( _KiTrap2C,0x2C)
TRAPHANDLER_NOEC( _KiTrap2D,0x2D)
TRAPHANDLER_NOEC( _KiTrap2E,0x2E)
TRAPHANDLER_NOEC( _KiTrap2F,0x2F)
TRAPHANDLER_NOEC( _KiTrap30,0x30)
TRAPHANDLER_NOEC( _KiTrap31,0x31)
TRAPHANDLER_NOEC( _KiTrap32,0x32)
TRAPHANDLER_NOEC( _KiTrap33,0x33)
TRAPHANDLER_NOEC( _KiTrap34,0x34)
TRAPHANDLER_NOEC( _KiTrap35,0x35)
TRAPHANDLER_NOEC( _KiTrap36,0x36)
TRAPHANDLER_NOEC( _KiTrap37,0x37)
TRAPHANDLER_NOEC( _KiTrap38,0x38)
TRAPHANDLER_NOEC( _KiTrap39,0x39)
TRAPHANDLER_NOEC( _KiTrap3A,0x3A)
TRAPHANDLER_NOEC( _KiTrap3B,0x3B)
TRAPHANDLER_NOEC( _KiTrap3C,0x3C)
TRAPHANDLER_NOEC( _KiTrap3D,0x3D)
TRAPHANDLER_NOEC( _KiTrap3E,0x3E)
TRAPHANDLER_NOEC( _KiTrap3F,0x3F)
TRAPHANDLER_NOEC( _KiTrap40,0x40)
TRAPHANDLER_NOEC( _KiTrap41,0x41)
TRAPHANDLER_NOEC( _KiTrap42,0x42)
TRAPHANDLER_NOEC( _KiTrap43,0x43)
TRAPHANDLER_NOEC( _KiTrap44,0x44)
TRAPHANDLER_NOEC( _KiTrap45,0x45)
TRAPHANDLER_NOEC( _KiTrap46,0x46)
TRAPHANDLER_NOEC( _KiTrap47,0x47)
TRAPHANDLER_NOEC( _KiTrap48,0x48)
TRAPHANDLER_NOEC( _KiTrap49,0x49)
TRAPHANDLER_NOEC( _KiTrap4A,0x4A)
TRAPHANDLER_NOEC( _KiTrap4B,0x4B)
TRAPHANDLER_NOEC( _KiTrap4C,0x4C)
TRAPHANDLER_NOEC( _KiTrap4D,0x4D)
TRAPHANDLER_NOEC( _KiTrap4E,0x4E)
TRAPHANDLER_NOEC( _KiTrap4F,0x4F)
TRAPHANDLER_NOEC( _KiTrap50,0x50)
TRAPHANDLER_NOEC( _KiTrap51,0x51)
TRAPHANDLER_NOEC( _KiTrap52,0x52)
TRAPHANDLER_NOEC( _KiTrap53,0x53)
TRAPHANDLER_NOEC( _KiTrap54,0x54)
TRAPHANDLER_NOEC( _KiTrap55,0x55)
TRAPHANDLER_NOEC( _KiTrap56,0x56)
TRAPHANDLER_NOEC( _KiTrap57,0x57)
TRAPHANDLER_NOEC( _KiTrap58,0x58)
TRAPHANDLER_NOEC( _KiTrap59,0x59)
TRAPHANDLER_NOEC( _KiTrap5A,0x5A)
TRAPHANDLER_NOEC( _KiTrap5B,0x5B)
TRAPHANDLER_NOEC( _KiTrap5C,0x5C)
TRAPHANDLER_NOEC( _KiTrap5D,0x5D)
TRAPHANDLER_NOEC( _KiTrap5E,0x5E)
TRAPHANDLER_NOEC( _KiTrap5F,0x5F)
TRAPHANDLER_NOEC( _KiTrap60,0x60)
TRAPHANDLER_NOEC( _KiTrap61,0x61)
TRAPHANDLER_NOEC( _KiTrap62,0x62)
TRAPHANDLER_NOEC( _KiTrap63,0x63)
TRAPHANDLER_NOEC( _KiTrap64,0x64)
TRAPHANDLER_NOEC( _KiTrap65,0x65)
TRAPHANDLER_NOEC( _KiTrap66,0x66)
TRAPHANDLER_NOEC( _KiTrap67,0x67)
TRAPHANDLER_NOEC( _KiTrap68,0x68)
TRAPHANDLER_NOEC( _KiTrap69,0x69)
TRAPHANDLER_NOEC( _KiTrap6A,0x6A)
TRAPHANDLER_NOEC( _KiTrap6B,0x6B)
TRAPHANDLER_NOEC( _KiTrap6C,0x6C)
TRAPHANDLER_NOEC( _KiTrap6D,0x6D)
TRAPHANDLER_NOEC( _KiTrap6E,0x6E)
TRAPHANDLER_NOEC( _KiTrap6F,0x6F)
TRAPHANDLER_NOEC( _KiTrap70,0x70)
TRAPHANDLER_NOEC( _KiTrap71,0x71)
TRAPHANDLER_NOEC( _KiTrap72,0x72)
TRAPHANDLER_NOEC( _KiTrap73,0x73)
TRAPHANDLER_NOEC( _KiTrap74,0x74)
TRAPHANDLER_NOEC( _KiTrap75,0x75)
TRAPHANDLER_NOEC( _KiTrap76,0x76)
TRAPHANDLER_NOEC( _KiTrap77,0x77)
TRAPHANDLER_NOEC( _KiTrap78,0x78)
TRAPHANDLER_NOEC( _KiTrap79,0x79)
TRAPHANDLER_NOEC( _KiTrap7A,0x7A)
TRAPHANDLER_NOEC( _KiTrap7B,0x7B)
TRAPHANDLER_NOEC( _KiTrap7C,0x7C)
TRAPHANDLER_NOEC( _KiTrap7D,0x7D)
TRAPHANDLER_NOEC( _KiTrap7E,0x7E)
TRAPHANDLER_NOEC( _KiTrap7F,0x7F)
TRAPHANDLER_NOEC( _KiTrap80,0x80)
TRAPHANDLER_NOEC( _KiTrap81,0x81)
TRAPHANDLER_NOEC( _KiTrap82,0x82)
TRAPHANDLER_NOEC( _KiTrap83,0x83)
TRAPHANDLER_NOEC( _KiTrap84,0x84)
TRAPHANDLER_NOEC( _KiTrap85,0x85)
TRAPHANDLER_NOEC( _KiTrap86,0x86)
TRAPHANDLER_NOEC( _KiTrap87,0x87)
TRAPHANDLER_NOEC( _KiTrap88,0x88)
TRAPHANDLER_NOEC( _KiTrap89,0x89)
TRAPHANDLER_NOEC( _KiTrap8A,0x8A)
TRAPHANDLER_NOEC( _KiTrap8B,0x8B)
TRAPHANDLER_NOEC( _KiTrap8C,0x8C)
TRAPHANDLER_NOEC( _KiTrap8D,0x8D)
TRAPHANDLER_NOEC( _KiTrap8E,0x8E)
TRAPHANDLER_NOEC( _KiTrap8F,0x8F)
TRAPHANDLER_NOEC( _KiTrap90,0x90)
TRAPHANDLER_NOEC( _KiTrap91,0x91)
TRAPHANDLER_NOEC( _KiTrap92,0x92)
TRAPHANDLER_NOEC( _KiTrap93,0x93)
TRAPHANDLER_NOEC( _KiTrap94,0x94)
TRAPHANDLER_NOEC( _KiTrap95,0x95)
TRAPHANDLER_NOEC( _KiTrap96,0x96)
TRAPHANDLER_NOEC( _KiTrap97,0x97)
TRAPHANDLER_NOEC( _KiTrap98,0x98)
TRAPHANDLER_NOEC( _KiTrap99,0x99)
TRAPHANDLER_NOEC( _KiTrap9A,0x9A)
TRAPHANDLER_NOEC( _KiTrap9B,0x9B)
TRAPHANDLER_NOEC( _KiTrap9C,0x9C)
TRAPHANDLER_NOEC( _KiTrap9D,0x9D)
TRAPHANDLER_NOEC( _KiTrap9E,0x9E)
TRAPHANDLER_NOEC( _KiTrap9F,0x9F)
TRAPHANDLER_NOEC( _KiTrapA0,0xA0)
TRAPHANDLER_NOEC( _KiTrapA1,0xA1)
TRAPHANDLER_NOEC( _KiTrapA2,0xA2)
TRAPHANDLER_NOEC( _KiTrapA3,0xA3)
TRAPHANDLER_NOEC( _KiTrapA4,0xA4)
TRAPHANDLER_NOEC( _KiTrapA5,0xA5)
TRAPHANDLER_NOEC( _KiTrapA6,0xA6)
TRAPHANDLER_NOEC( _KiTrapA7,0xA7)
TRAPHANDLER_NOEC( _KiTrapA8,0xA8)
TRAPHANDLER_NOEC( _KiTrapA9,0xA9)
TRAPHANDLER_NOEC( _KiTrapAA,0xAA)
TRAPHANDLER_NOEC( _KiTrapAB,0xAB)
TRAPHANDLER_NOEC( _KiTrapAC,0xAC)
TRAPHANDLER_NOEC( _KiTrapAD,0xAD)
TRAPHANDLER_NOEC( _KiTrapAE,0xAE)
TRAPHANDLER_NOEC( _KiTrapAF,0xAF)
TRAPHANDLER_NOEC( _KiTrapB0,0xB0)
TRAPHANDLER_NOEC( _KiTrapB1,0xB1)
TRAPHANDLER_NOEC( _KiTrapB2,0xB2)
TRAPHANDLER_NOEC( _KiTrapB3,0xB3)
TRAPHANDLER_NOEC( _KiTrapB4,0xB4)
TRAPHANDLER_NOEC( _KiTrapB5,0xB5)
TRAPHANDLER_NOEC( _KiTrapB6,0xB6)
TRAPHANDLER_NOEC( _KiTrapB7,0xB7)
TRAPHANDLER_NOEC( _KiTrapB8,0xB8)
TRAPHANDLER_NOEC( _KiTrapB9,0xB9)
TRAPHANDLER_NOEC( _KiTrapBA,0xBA)
TRAPHANDLER_NOEC( _KiTrapBB,0xBB)
TRAPHANDLER_NOEC( _KiTrapBC,0xBC)
TRAPHANDLER_NOEC( _KiTrapBD,0xBD)
TRAPHANDLER_NOEC( _KiTrapBE,0xBE)
TRAPHANDLER_NOEC( _KiTrapBF,0xBF)
TRAPHANDLER_NOEC( _KiTrapC0,0xC0)
TRAPHANDLER_NOEC( _KiTrapC1,0xC1)
TRAPHANDLER_NOEC( _KiTrapC2,0xC2)
TRAPHANDLER_NOEC( _KiTrapC3,0xC3)
TRAPHANDLER_NOEC( _KiTrapC4,0xC4)
TRAPHANDLER_NOEC( _KiTrapC5,0xC5)
TRAPHANDLER_NOEC( _KiTrapC6,0xC6)
TRAPHANDLER_NOEC( _KiTrapC7,0xC7)
TRAPHANDLER_NOEC( _KiTrapC8,0xC8)
TRAPHANDLER_NOEC( _KiTrapC9,0xC9)
TRAPHANDLER_NOEC( _KiTrapCA,0xCA)
TRAPHANDLER_NOEC( _KiTrapCB,0xCB)
TRAPHANDLER_NOEC( _KiTrapCC,0xCC)
TRAPHANDLER_NOEC( _KiTrapCD,0xCD)
TRAPHANDLER_NOEC( _KiTrapCE,0xCE)
TRAPHANDLER_NOEC( _KiTrapCF,0xCF)
TRAPHANDLER_NOEC( _KiTrapD0,0xD0)
TRAPHANDLER_NOEC( _KiTrapD1,0xD1)
TRAPHANDLER_NOEC( _KiTrapD2,0xD2)
TRAPHANDLER_NOEC( _KiTrapD3,0xD3)
TRAPHANDLER_NOEC( _KiTrapD4,0xD4)
TRAPHANDLER_NOEC( _KiTrapD5,0xD5)
TRAPHANDLER_NOEC( _KiTrapD6,0xD6)
TRAPHANDLER_NOEC( _KiTrapD7,0xD7)
TRAPHANDLER_NOEC( _KiTrapD8,0xD8)
TRAPHANDLER_NOEC( _KiTrapD9,0xD9)
TRAPHANDLER_NOEC( _KiTrapDA,0xDA)
TRAPHANDLER_NOEC( _KiTrapDB,0xDB)
TRAPHANDLER_NOEC( _KiTrapDC,0xDC)
TRAPHANDLER_NOEC( _KiTrapDD,0xDD)
TRAPHANDLER_NOEC( _KiTrapDE,0xDE)
TRAPHANDLER_NOEC( _KiTrapDF,0xDF)
TRAPHANDLER_NOEC( _KiTrapE0,0xE0)
TRAPHANDLER_NOEC( _KiTrapE1,0xE1)
TRAPHANDLER_NOEC( _KiTrapE2,0xE2)
TRAPHANDLER_NOEC( _KiTrapE3,0xE3)
TRAPHANDLER_NOEC( _KiTrapE4,0xE4)
TRAPHANDLER_NOEC( _KiTrapE5,0xE5)
TRAPHANDLER_NOEC( _KiTrapE6,0xE6)
TRAPHANDLER_NOEC( _KiTrapE7,0xE7)
TRAPHANDLER_NOEC( _KiTrapE8,0xE8)
TRAPHANDLER_NOEC( _KiTrapE9,0xE9)
TRAPHANDLER_NOEC( _KiTrapEA,0xEA)
TRAPHANDLER_NOEC( _KiTrapEB,0xEB)
TRAPHANDLER_NOEC( _KiTrapEC,0xEC)
TRAPHANDLER_NOEC( _KiTrapED,0xED)
TRAPHANDLER_NOEC( _KiTrapEE,0xEE)
TRAPHANDLER_NOEC( _KiTrapEF,0xEF)
TRAPHANDLER_NOEC( _KiTrapF0,0xF0)
TRAPHANDLER_NOEC( _KiTrapF1,0xF1)
TRAPHANDLER_NOEC( _KiTrapF2,0xF2)
TRAPHANDLER_NOEC( _KiTrapF3,0xF3)
TRAPHANDLER_NOEC( _KiTrapF4,0xF4)
TRAPHANDLER_NOEC( _KiTrapF5,0xF5)
TRAPHANDLER_NOEC( _KiTrapF6,0xF6)
TRAPHANDLER_NOEC( _KiTrapF7,0xF7)
TRAPHANDLER_NOEC( _KiTrapF8,0xF8)
TRAPHANDLER_NOEC( _KiTrapF9,0xF9)
TRAPHANDLER_NOEC( _KiTrapFA,0xFA)
TRAPHANDLER_NOEC( _KiTrapFB,0xFB)
TRAPHANDLER_NOEC( _KiTrapFC,0xFC)
TRAPHANDLER_NOEC( _KiTrapFD,0xFD)
TRAPHANDLER_NOEC( _KiTrapFE,0xFE)






.text


_KiSaveTrapFrame:
	push	ds
	push	es
	pushad
	// load GD_KD into ds and es
	mov	eax, GD_KD	
	mov	ds, ax
	mov	es, ax
	// pass arguments trapframe
	push	esp
	call _KiTrap


//ENTRY(_KiRestoreTrapFrame)	// We might use it elsewhere
// Pop everything back

	pop	eax
	popad
	pop	es
	pop	ds
	add	esp, 0x8
	iret




	
